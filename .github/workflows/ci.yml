name: CI-CD Pipeline

on:
  push:
    branches: ["main"]
  pull_request:

jobs:

  mlops:
    name: Train + Build + Deploy
    runs-on: ubuntu-latest

    env:
      MLFLOW_TRACKING_URI: file:./mlruns
      PYTHONPATH: .

    steps:
      # ---- 1Ô∏è‚É£ Checkout Code ----
      - name: Checkout repository
        uses: actions/checkout@v3

      # ---- 2Ô∏è‚É£ Setup Python ----
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      # ---- 3Ô∏è‚É£ Install Dependencies ----
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install dvc

      # ---- 4Ô∏è‚É£ DVC Data (optional remote) ----
      - name: Pull DVC data (local fallback)
        continue-on-error: true
        run: |
          dvc pull || echo "‚ö† Using local data only."

      # ---- 5Ô∏è‚É£ Data Preprocessing ----
      - name: Data preprocessing
        run: |
          python mlops_src/data_preprocess.py \
            --input data/raw/flight_price.csv \
            --out_dir data/processed

      # ---- 6Ô∏è‚É£ Feature Pipeline Build ----
      - name: Build feature pipeline
        run: |
          python mlops_src/feature_pipeline.py \
            --data data/processed/train_data.csv \
            --artifacts backend_artifacts

      # ---- 7Ô∏è‚É£ Model Training ----
      - name: Train + tune XGBoost with MLflow
        run: |
          python mlops_src/train.py

      # ---- 8Ô∏è‚É£ Sync artifacts ‚Üí docker backend ----
      - name: Update backend artifacts
        run: |
          python mlops_src/update_artifacts.py

      # ---- 9Ô∏è‚É£ Build Docker Image ----
      - name: Build Docker image
        run: |
          docker build -t aeroprice-backend ./docker_backend

      # ---- üîü Deploy to Render ----
      - name: Deploy to Render
        env:
          RENDER_TOKEN: ${{ secrets.RENDER_TOKEN }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          curl -X POST \
          -H "Authorization: Bearer $RENDER_TOKEN" \
          -H "accept: application/json" \
          -H "content-type: application/json" \
          -d '{"clearCache": "clear"}' \
          https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys
